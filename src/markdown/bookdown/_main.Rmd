---
title: "Technisch rapport 11 jaar Slak-in-Du"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
output:
  bookdown::html_document2:
      code_folding: hide
      toc: true
      toc_float: true
      toc_collapsed: true
      df_print: paged
bibliography: [references.bib, packages.bib]
csl: american-psychological-association-7th-edition.csl
link-citations: yes
editor_options: 
  chunk_output_type: console
---

<!--chapter:end:index.Rmd-->

# Inleiding{#inleiding}

```{r setup, message = FALSE, warning = FALSE}
# Opties
library(knitr)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)

# Packages
library(tidyverse)
library(sf)
library(mapview)
library(rgbif)

# Source
slak_in_du_dir <- "C:/Users/WARD/Documents/slakken/Slak-in-Du/analyses/slak-in-du"
source(file.path(slak_in_du_dir, "src", "R", "functions.R"))

# References
knitr::write_bib(c("tidyverse", "sf", "mapview", "rgbif"), 
                 file = "packages.bib")
```

Dit technisch rapport is geschreven ter ondersteuning van het Slak-in-Du rapport na 11 jaar veldwerk in de kustduinen en -polders. Het doel is een volledig beeld van alle mogelijke informatie uit de data weer te geven. Relevante informatie en/of figuren kunnen dan geselecteerd worden die in het eigenlijke rapport moeten worden gebruikt.\
Bovendien wordt de methodiek zo goed mogelijk uitgeschreven zodat mensen met verschillende achtergronden kunnen opzoeken en begrijpen hoe de dataverwerking en -analyses zijn verricht, zonder zelf op de hoogte te moeten zijn van de technische details of gebruikte programmeercode.

Het technisch rapport bestaat uit vier delen:

1.  Afbakening van het Slak-in-Du gebied aan de kust. Het studiegebied kan dan gebruikt worden om de data te selecteren en UTM-hokken te selectieren die kunnen gebruikt worden om verspreidingskaarten te maken. Hoofdstuk \@ref(studiegebied).
2.  Selectie van de data en data preparatie voor verdere analyses. Hoofdstuk \@ref(dataselectie).
3.  Maken van "atlas-stijl" verspreidingskaarten m.b.v. UTM-hokken op verschillende schalen. Hoofdstuk \@ref(verspreidingskaarten).
4.  Exploratie van de data om samenvattende cijfers en tabellen te genereren. Hoofdstuk \@ref(exploratie).

Alle dataverwerking en analyses zijn verricht met R v4.1.2 in RStudio v2021.9.0.351 [@RStudio2021;@R2021] tenzij anders vermeld. Voor dataverwerking en visualisatie werd gebruik gemaakt van de **tidyverse** package v1.3.1 [@R-tidyverse; @tidyverse2019]. De **sf** package v1.0-7 [@R-sf; @sf2018] werd gebruikt voor de verwerking van de kaartlagen en **mapview** v2.11.0 [@R-mapview] voor het creëren van interactieve kaarten. Ten slotte werd de **rgbif** package v3.7.2 [@R-rgbif; @rgbif2017] gebruikt voor het ophalen van de weteschappelijke namen via de GBIF taxonomic backbone [@GBIFtax2022, via GBIF.org op `r Sys.Date()`].

<!--chapter:end:01_inleiding.Rmd-->

# Selectie studiegebied{#studiegebied}
## Doel

Onderzoeksgebied afbakenen voor Slak-in-Du aan de kust. UTM grid over dit gebied op verschillende schalen exporteren om later te gebruiken om verspreidingskaarten te maken.


## Data inlezen

We lezen de volgende kaarten in: 

- UTM 1 km hokken van België
- UTM 2 km hokken van België
- UTM 5 km hokken van België
- UTM 10 km hokken van België
- ecoregio's van Vlaanderen
- uitbreiding regio kustduinen
- provincies van Vlaanderen

```{r, results="hide"}
# Locatie van data en output mappen
data_path <- file.path(slak_in_du_dir, "data", "raw")
out_path <- file.path(slak_in_du_dir, "data", "processed")

# Lees kaartlagen in
utm_1km <- st_read(paste(data_path, "utm1_bel.shp", sep = "/"))
utm_2km <- st_read(paste(data_path, "utm2_bel.shp", sep = "/"))
utm_5km <- st_read(paste(data_path, "utm5_bel.shp", sep = "/"))
utm_10km <- st_read(paste(data_path, "utm10_bel.shp", sep = "/"))

ecoregios <- st_read(paste(data_path, "ecoregio2002.shp", sep = "/"))
uitbreiding_kust <- st_read(paste(data_path, "uitbreiding_ecoregio2002.shp", 
                            sep = "/"))
provincies <- st_read(paste(data_path, "Refprv.shp", sep = "/"))

# Referentie coordinatensysteem: UTM zone 31N
proj_crs <- 32631

# Alle kaartlagen zelfde referentiesysteem
utm_1km <- st_transform(utm_1km, crs = proj_crs)
utm_2km <- st_transform(utm_2km, crs = proj_crs)
utm_5km <- st_transform(utm_5km, crs = proj_crs)
utm_10km <- st_transform(utm_10km, crs = proj_crs)
ecoregios <- st_transform(ecoregios, crs = proj_crs)
uitbreiding_kust <- st_transform(uitbreiding_kust, crs = proj_crs)
provincies <- st_transform(provincies, crs = proj_crs)
```

Visualisatie van de kaartlagen:

```{r, cache=TRUE}
# Plot UTM grids naast elkaar
utm_1km_plot <- ggplot() +
                  geom_sf(data = utm_1km) +
                  labs(title = "UTM 1 km België")
utm_2km_plot <- ggplot() +
                  geom_sf(data = utm_2km) +
                  labs(title = "UTM 2 km België")
utm_5km_plot <- ggplot() +
                  geom_sf(data = utm_5km) +
                  labs(title = "UTM 5 km België")
utm_10km_plot <- ggplot() +
                  geom_sf(data = utm_10km) +
                  labs(title = "UTM 10 km België")

utm_1km_plot
utm_2km_plot
utm_5km_plot
utm_10km_plot

# Plot ecoregio's
ecoregios %>% 
  mutate(ecoregio = gsub("Ecoregio van de ", "", REGIO)) %>%
  ggplot() + 
    geom_sf(aes(fill = ecoregio)) +
    labs(title = "Ecoregio's Vlaanderen", fill = "") +
    theme(legend.position = "bottom")

# Plot uitbreiding ecoregio kustduinen
uitbreiding_kust %>%
  ggplot() + 
    geom_sf() +
    labs(title = "Uitbreiding ecoregio kustduinen")

# Plot provincies
provincies %>%
  ggplot() + 
    geom_sf(aes(fill = NAAM)) +
    labs(title = "Provincies Vlaanderen", fill = "") +
    theme(legend.position = "bottom")
```


## Selectie Slak-in-Du gebied

We selecteren de ecoregio's "kustduinen" en "polders en de getijdenschelde" gelegen in West-Vlaanderen. Daarvoor extraheren we eerst West-Vlaanderen uit de provincie-kaartlaag.

```{r subset-selectie}
# Selecteer West-Vlaanderen
west_vlaanderen <- provincies %>% filter(NAAM == "West-Vlaanderen")

# Selecteer kustduinen en polders
eco_selectie <- ecoregios %>% 
  mutate(ecoregio = gsub("Ecoregio van de ", "", REGIO)) %>%
  filter(ecoregio %in% c("kustduinen", "polders en de getijdenschelde"))

# Controle
eco_selectie %>%
  ggplot() + 
    geom_sf(data = provincies, fill = alpha("black", 0)) +
    geom_sf(aes(fill = ecoregio)) +
    geom_sf(data = west_vlaanderen, fill = alpha("black", 0.2), size = 0.8) +
    labs(fill = "") +
    theme(legend.position = "bottom")
```

Daarna gebruiken we West-Vlaanderen om een stuk uit de ecoregio-laag te knippen. Dit is nodig aangezien de "polders en de getijdenschelde" ook buiten West-Vlaanderen te vinden zijn, maar die hebben wij niet nodig. We zijn enkel geïnteresseerd in de kustpolders.

```{r intersectie-wvl}
# Neem de intersectie van beide lagen
intersect_wvl <- st_intersection(west_vlaanderen, eco_selectie) %>%
  mutate(ecoregio = ifelse(ecoregio == "polders en de getijdenschelde", 
                           "kustpolders", "kustduinen"))

# Controle
intersect_wvl %>%
  ggplot() +
    geom_sf(aes(fill = ecoregio)) +
    labs(fill = "") +
    theme(legend.position = "bottom")
```


## Uitbreiding regio kustduinen

We moeten de ecoregio kaart uitbreiden omdat deze incompleet is voor de kustduinen. Dit was het geval voor de haven van Zeebrugge, de Baai van Heist en een deel van de Zwinduinen. 

```{r}
uitbreiding_kust %>%
  mutate(OIDN = 1, UIDN = NA, VERSDATUM = NA, TERRID = NA,
         NAAM = "West-Vlaanderen", NISCODE = NA, NUTS2 = NA, LENGTE = NA,
         OPPERVL = NA, REGIO = "Ecoregio van de kustduinen", CODE = NA, 
         HECTARES = NA, ecoregio = "kustduinen") %>%
  select(-id) %>%
  rbind(intersect_wvl) %>%
  mutate(ecoregio = ifelse(OIDN == 1, "kustduinen - uitbreiding", ecoregio)) %>%
  ggplot() +
    geom_sf(aes(fill = ecoregio)) +
    labs(fill = "") +
    theme(legend.position = "bottom")
```

Deze uitbreiding werd manueel getekend in QGIS v3.2.3 [@QGIS2018Software] op basis van een satellietkaart. We voegen deze uitbreiding nu bij de finale laag bekomen in vorige deel om het deelgebied kustduinen uit te breiden.

```{r}
intersect_wvl2 <- intersect_wvl %>%
  filter(ecoregio == "kustduinen") %>%
  st_union(uitbreiding_kust %>% st_buffer(0.5)) %>%
  select(-id) %>%
  rbind(intersect_wvl %>% filter(ecoregio == "kustpolders"))

ggplot(intersect_wvl2) +
    geom_sf(aes(fill = ecoregio)) +
    labs(fill = "") +
    theme(legend.position = "bottom")
```


## Overlap UTM-hokken en uitschrijven lijst

Nu overlappen we de laatste laag met de UTM-hokken.

```{r intersectie-utm}
# Neem de intersectie van beide lagen voor 5 en 10 km
intersect_utm1 <- st_intersection(intersect_wvl2, utm_1km)
intersect_utm2 <- st_intersection(intersect_wvl2, utm_2km)
intersect_utm5 <- st_intersection(intersect_wvl2, utm_5km)
intersect_utm10 <- st_intersection(intersect_wvl2, utm_10km)

# Controle
p1 <- intersect_utm1 %>%
        ggplot() +
          geom_sf(aes(fill = ecoregio)) +
          coord_sf(datum = proj_crs) +
          labs(title = "UTM 1 km - UTM 31 N", fill = "") +
          theme(legend.position = "bottom")
p2 <- intersect_utm2 %>%
        ggplot() +
          geom_sf(aes(fill = ecoregio)) +
          coord_sf(datum = proj_crs) +
          labs(title = "UTM 2 km - UTM 31 N", fill = "") +
          theme(legend.position = "bottom")
p3 <- intersect_utm5 %>%
        ggplot() +
          geom_sf(aes(fill = ecoregio)) +
          coord_sf(datum = proj_crs) +
          labs(title = "UTM 5 km - UTM 31 N", fill = "") +
          theme(legend.position = "bottom")
p4 <- intersect_utm10 %>%
        ggplot() +
          geom_sf(aes(fill = ecoregio)) +
          coord_sf(datum = proj_crs) +
          labs(title = "UTM 10 km - UTM 31 N", fill = "") +
          theme(legend.position = "bottom")

p1
p2
p3
p4
```

We willen een lijst van de UTM hokken op 5 en 10 km schaal. De namen van de hokken bevinden zich in de kolom `TAG`. Daaruit kunnen we selecteren, maar we hernoemen deze resp. naar `utm_5` en `utm_10` voor de 5 en 10 km hokken. Ze worden hier opgelijst en schrijven ze ook uit naar een Excel-file.

```{r tabel-utm}
# Maak een mooie tabel
utm_5km_out <- intersect_utm5 %>%
                 st_drop_geometry() %>%
                 select(TAG) %>%
                 arrange(TAG) %>%
                 distinct(TAG) %>%
                 rename(utm_5 = TAG)
rownames(utm_5km_out) <- NULL
utm_5km_out

utm_10km_out <- intersect_utm10 %>%
                 st_drop_geometry() %>%
                 select(TAG) %>%
                 arrange(TAG) %>%
                 distinct(TAG) %>%
                 rename(utm_10 = TAG)
rownames(utm_10km_out) <- NULL
utm_10km_out
```

```{r output-utm}
# Output naar Excel
wb <- openxlsx::createWorkbook()
openxlsx::addWorksheet(wb, "utm_10km")
openxlsx::addWorksheet(wb, "utm_5km")

openxlsx::writeData(wb, sheet = "utm_10km", utm_10km_out)
openxlsx::writeData(wb, sheet = "utm_5km", utm_5km_out)

openxlsx::saveWorkbook(wb, file = paste(out_path, "utm_hokken_slakindu.xlsx", 
                       sep = "/"), overwrite = TRUE)
```


## Visualisatie en export kaart geselecteerde hokken

```{r plot-utm}
# Maak selectie UTM-hokken
utm_1km_lijst <- unique(intersect_utm1$TAG)
utm_2km_lijst <- unique(intersect_utm2$TAG)
utm_5km_lijst <- unique(intersect_utm5$TAG)
utm_10km_lijst <- unique(intersect_utm10$TAG)

# Maak kaartlagen van selecie UTM-hokken
utm_1km_kust <- utm_1km %>% 
  filter(TAG %in% utm_1km_lijst)

utm_2km_kust <- utm_2km %>% 
  filter(TAG %in% utm_2km_lijst)

utm_5km_kust <- utm_5km %>% 
  filter(TAG %in% utm_5km_lijst)

utm_10km_kust <- utm_10km %>% 
  filter(TAG %in% utm_10km_lijst)

# Plots
utm_1km_kust %>%
  ggplot() +
    geom_sf(data = intersect_wvl2, aes(fill = ecoregio), alpha = 0.5) +
    geom_sf(fill = alpha("black", 0)) +
    coord_sf(datum = proj_crs) +
    labs(title = "UTM 1 km - UTM zone 31N") +
    theme(legend.position = "bottom",
          axis.title = element_blank())

utm_2km_kust %>%
  ggplot() +
    geom_sf(data = intersect_wvl2, aes(fill = ecoregio), alpha = 0.5) +
    geom_sf(fill = alpha("black", 0)) +
    coord_sf(datum = proj_crs) +
    labs(title = "UTM 2 km - UTM zone 31N") +
    theme(legend.position = "bottom",
          axis.title = element_blank())

utm_5km_kust %>%
  ggplot() +
    geom_sf(data = intersect_wvl2, aes(fill = ecoregio), alpha = 0.5) +
    geom_sf(fill = alpha("black", 0)) +
    geom_sf_text(aes(label = TAG), size = 1.5) +
    coord_sf(datum = proj_crs) +
    labs(title = "UTM 5 km - UTM zone 31N") +
    theme(legend.position = "bottom",
          axis.title = element_blank())

utm_10km_kust %>%
  ggplot() +
    geom_sf(data = intersect_wvl2, aes(fill = ecoregio), alpha = 0.5) +
    geom_sf(fill = alpha("black", 0)) +
    geom_sf_text(aes(label = TAG), size = 2.5) +
    coord_sf(datum = proj_crs) +
    labs(title = "UTM 10 km - UTM zone 31N") +
    theme(legend.position = "bottom",
          axis.title = element_blank())
```

Ten slotte exporteren we de kaartlagen van het onderzoeksgebied en de verschillende UTM-hokken over het onderzoeksgebied als .shp-files.

```{r}
# Output .shp-files
st_write(intersect_wvl2, paste(out_path, "studiegebied_kust.shp", 
                               sep = "/"), 
         delete_dsn = TRUE)
st_write(utm_1km_kust, paste(out_path, "utm_1km_kust.shp", 
                             sep = "/"), 
         delete_dsn = TRUE)
st_write(utm_2km_kust, paste(out_path, "utm_2km_kust.shp", 
                             sep = "/"), 
         delete_dsn = TRUE)
st_write(utm_5km_kust, paste(out_path, "utm_5km_kust.shp", 
                             sep = "/"), 
         delete_dsn = TRUE)
st_write(utm_10km_kust, paste(out_path, "utm_10km_kust.shp", 
                              sep = "/"), 
         delete_dsn = TRUE)
```

<!--chapter:end:02_kilometerhok_selectie_kust.Rmd-->

# Dataselectie{#dataselectie}
## Doel

Selectie van de observaties die gebruikt zullen in het eindrapport van Slak-in-Du aan de kust. Voorbereiden van finale dataset voor data exploratie en analyses.


## Data inlezen

We lezen de volgende kaarten in: 

- Studiegebied aan de kust

Deze bevat twee ecoregio's. We voegen deze samen zodat we een enkele kaart hebben van het volledige studiegebied. 

```{r}
# Locatie van data en output mappen
data_path <- file.path(slak_in_du_dir, "data", "raw")
out_path <- file.path(slak_in_du_dir, "data", "processed")

# Lees kaartlagen in
studiegebied_kust <- st_read(paste(out_path, "studiegebied_kust.shp", 
                                   sep = "/"))

# Voeg ecoregio's samen tot één studiegebied
studiegebied_kust_merged <- studiegebied_kust %>%
  st_buffer(0.5) %>%
  st_union()

# Referentie coordinatensysteem: UTM zone 31N
proj_crs <- 32631
```

Visualisatie van de kaartlagen:

```{r}
# Maak thema voor plotten van kaartjes
mytheme <- theme(panel.grid.major = element_line(color = "grey", 
                                                 linetype = "dashed", 
                                                 size = 0.3),
                 panel.background = element_rect(fill = "aliceblue"),
                 axis.title = element_blank())

# Plot kaarten
studiegebied_kust_merged %>%
  ggplot() +
    geom_sf(fill = "white") +
    mytheme
```

We lezen de waarnemingendata in van Slak-in-Du. Laatste download 21-01-2023.

```{r}
# Laad data
ruwe_data <- read_csv(paste(data_path, "observations-slak-in-du.csv",
                               sep = "/"))

# Zet om naar sf object
ruwe_data_sf <- ruwe_data %>% 
  mutate(latitude = lat, longitude = lng) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

# Zet crs om naar project crs
ruwe_data_sf <- ruwe_data_sf %>%
  st_transform(crs = proj_crs)
```

## Dataselectie

We selecteren daarna de waarnemingen binnen het studiegebied aan de kust.

```{r}
# Selectie waarnemingen binnen studiegebied
waarnemingen_kust <- ruwe_data_sf %>%
  st_intersection(studiegebied_kust_merged)
```

### Randgevallen

Zijn er punten die vlak buiten het gebied vallen, maar die wel van belang zijn?

```{r}
# Selecteer correcte observaties binnen gebied
correct_obs <- waarnemingen_kust
id_correct_obs <- correct_obs$id

# Selecteer observaties net buiten gebied
net_erbuiten <- ruwe_data_sf %>% 
  st_crop(xmin = 460000, xmax = 530000,
          ymin = 5640000, ymax = 5700000) %>%
  filter(!(id %in% id_correct_obs))

# Visualiseer
mapview(correct_obs, col.regions = "red") +
  mapview(net_erbuiten, col.regions = "blue") +
  mapview(studiegebied_kust_merged, col.regions = "white")
```

De punten ten zuiden van het studiegebied bevinden zich terecht niet in de selectie voor het huidige rapport. Het zijn waarnemingen van excursies naar Sint-Michiels en Ryckevelde/Schobbejakshoogte.

De punten ten noorden van het studiegebied moeten ook niet opgenomen worden. Het gaat om een aangespoelde schelp op het strand van Zeebrugge een een waarneming van een mariene soort (Amerikaanse strandschelp - *Mulinia lateralis*) aan de Baai van Heist.


### Selectie van soorten

We verwijderen alle mariene soorten uit de selectie. Het gaat om:  
Mossel, Japanse oester, Strandgaper, Macoma balthica, Witte dunschaal, Zaagje, Filipijnse tapijtschelp, Grofgeribde fuikhoren, Penhoren, Amerikaanse boormossel, Paalworm, Melkwitte arkschalp, Klein drijfhorentje, Ruwe alikruik-complex, Witte wenteltrap, Platte oester, Witte boormossel, Kokkel, Noorse hartschelp, Halfgeknotte strandschelp, Venusschelp, Gewone alikruik, Grote strandschelp, Angulus tenuis, Roze schotelhoren, Tweetandschelpje, Gekielde cirkelslak, Noordse rotsboorder, Bonte mantel, Gevlekt koffieboontje, Gewone priktolhoren, Purperslak, Stompe ribhoren, Vliezig drijfhorentje, Tolhoren onbekend, Gevlochten fuikhoren, Scheve hartschelp, Scheef bultschelpje, Stompe buishoren, Muizenkeuteltje, Klein traliehorentje, Paardenzadel, Haustator solanderi, Glanzende tepelhoren, Oubliehoren, Gewone marmerschelp, Wulk, Grote tepelhoren, Hongaarse muts, Amerikaanse strandschelp, Corbula gibba, Platte slijkgaper, Tere dunschaal, Driehoekige parelmoerneut.

```{r}
mariene_mollusken <- c("Mossel", "Japanse oester", "Strandgaper", 
  "Macoma balthica", "Witte dunschaal", "Zaagje", "Filipijnse tapijtschelp", 
  "Grofgeribde fuikhoren", "Penhoren", "Amerikaanse boormossel", "Paalworm", 
  "Melkwitte arkschelp", "Klein drijfhorentje", "Ruwe alikruik-complex", 
  "Witte wenteltrap", "Platte oester", "Witte boormossel", "Kokkel", 
  "Noorse hartschelp", "Halfgeknotte strandschelp", "Venusschelp", 
  "Gewone alikruik", "Grote strandschelp", "Angulus tenuis", 
  "Roze schotelhoren", "Tweetandschelpje", "Gekielde cirkelslak", 
  "Noordse rotsboorder", "Bonte mantel", "Gevlekt koffieboontje", 
  "Gewone priktolhoren", "Purperslak", "Stompe ribhoren", 
  "Vliezig drijfhorentje", "Tolhoren onbekend", "Gevlochten fuikhoren", 
  "Scheve hartschelp", "Scheef bultschelpje", "Stompe buishoren", 
  "Muizenkeuteltje", "Klein traliehorentje", "Paardenzadel", 
  "Haustator solanderi", "Glanzende tepelhoren", "Oubliehoren", 
  "Gewone marmerschelp", "Wulk", "Grote tepelhoren", "Hongaarse muts", 
  "Amerikaanse strandschelp", "Corbula gibba", "Platte slijkgaper", 
  "Tere dunschaal", "Driehoekige parelmoerneut")

land_zoetwater_kust <- waarnemingen_kust %>% 
  filter(!(`species name` %in% mariene_mollusken))
```


### Selectie relevante waarnemingen


```{r}
te_verwijderen <- c()
```

Zijn er waarnemingen van *aangespoelde schelpen*?

- in ```activity```

```{r}
land_zoetwater_kust %>%
  st_drop_geometry() %>%
  count(activity) %>%
  arrange(n) %>%
  kable()
```

Er is een aangespoelde schelp van de Grote glansslak en enkele van het Gewoon en Meertandig muizenoortje:

```{r}
land_zoetwater_kust %>%
  st_drop_geometry() %>%
  filter(activity == "aangespoeld") %>% 
  select(date, `species name`, number, `life stage`, activity, location, 
         link) %>%
  kable()

# voeg id toe aan vector om te verwijderen
te_verwijderen <- c(te_verwijderen, 
  land_zoetwater_kust %>%
    st_drop_geometry() %>%
    filter(activity == "aangespoeld") %>% 
    pull(id))
```

- in ```notes```

```{r}
any(grepl("aangespoeld", land_zoetwater_kust$notes, ignore.case = TRUE))
```

Woord 'aangespoeld' niet aanwezig in notes.  
  
  
Zijn er waarnemingen van *fossiele schelpen*?

- in ```method```

```{r}
land_zoetwater_kust %>%
  st_drop_geometry() %>%
  count(method) %>%
  arrange(n) %>%
  kable()
```

1 fossiel opgezwollen brakwaterhorentje en 4 fossiele wadslakjes:

```{r}
land_zoetwater_kust %>%
  st_drop_geometry() %>%
  filter(method == "fossiel") %>% 
  select(date, `species name`, number, `life stage`, activity, location, notes,
         link) %>%
  kable()

# voeg id toe aan vector om te verwijderen
te_verwijderen <- c(te_verwijderen, 
  land_zoetwater_kust %>%
    st_drop_geometry() %>%
    filter(method == "fossiel") %>% 
    pull(id))
```

- in ```notes```

70 verdere waarnemingen bevatten in notities het woord Holoceen, fossiel of 'middeleeuw'. De volgende tabel toont aantal per soort:

```{r}
land_zoetwater_kust %>%
  st_drop_geometry() %>%
  filter(method != "fossiel",
         grepl("fossiel|holoceen|middeleeuw", notes, ignore.case = TRUE)) %>%
  count(`species name`) %>%
  kable()

# voeg id toe aan vector om te verwijderen
te_verwijderen <- c(te_verwijderen, 
  land_zoetwater_kust %>%
    st_drop_geometry() %>%
  filter(method != "fossiel",
         grepl("fossiel|holoceen|middeleeuw", notes, ignore.case = TRUE)) %>% 
    pull(id))
```

We verwijderen de waarnemingen van de aangespoelde en fossiele schelpen. Het gaat om `r length(te_verwijderen)` waarnemingen.

```{r}
land_zoetwater_kust_selectie <- land_zoetwater_kust %>%
  filter(!(id %in% te_verwijderen))
```


## Data voorbereiden
### Controleer accuraatheid waarnemingen

Er is altijd onzekerheid op de exacte locatie van een waarneming. We zien een groot aantal waarnemingen met een accuraatheid groter dan 100 m (arbitrair maximum bepaald na communicatie via mail):

```{r}
land_zoetwater_kust_selectie %>%
  st_drop_geometry() %>%
  count(accuracy) %>%
  arrange(accuracy) %>%
  kable("html") %>%
  kableExtra::kable_styling(full_width = FALSE)
```

De waarnemingen van 26-05-2018 werden door Hans De Blauwe ingegeven en zetten we voor de zekerheid op 100 m nauwkeurigheid. De andere waarnemingen > 100 m werden door Franky gecontroleerd en zijn correct. Deze zetten we op 25 m. Alle waarnemingen met nauwkeurigheid < 25 m zetten we ook op 25 m (arbitrair minimum).

```{r}
land_zoetwater_kust_selectie <- land_zoetwater_kust_selectie %>%
  mutate(accuracy = case_when(
    accuracy < 25 ~ 25,
    accuracy > 100 & date == "2018-05-26" ~ 100,
    accuracy > 100 & date != "2018-05-26" ~ 25,
    TRUE ~ accuracy
  ))
```

De verdeling is nu als volgt:

```{r}
land_zoetwater_kust_selectie %>%
  st_drop_geometry() %>%
  count(accuracy) %>%
  arrange(accuracy) %>%
  kable("html") %>%
  kableExtra::kable_styling(full_width = FALSE)
```

In de data exploratie kunnen we dit visualiseren.


### Wetenschappelijke soortnamen

Gebruik de "GBIF-naamontleder" om nomenclatuurinformatie op te halen voor de wetenschappelijke namen in de dataset.

```{r}
parsed_names <- land_zoetwater_kust_selectie %>%
  distinct(`scientific name`) %>%
  pull() %>%
  parsenames()
```

Toon wetenschappelijke namen met nomenclatuurproblemen, d.w.z. niet van het `type = SCIENTIFIC` of die niet volledig zijn ontleed. Let op: deze zijn niet noodzakelijk onjuist.

```{r}
probleem_namen <- parsed_names %>%
  select(scientificname, type, parsed, parsedpartially, rankmarker) %>%
  filter(!(type == "SCIENTIFIC" & 
           parsed == "TRUE" & 
           parsedpartially == "FALSE"))
probleem_namen %>% kable
```

We voegen eerst wetenschappelijke namen en taxonomische info toe door te verbinden met de [GBIF taxonomic backbone](https://www.gbif.org/dataset/d7dddbf4-2cf0-4f39-9b2a-bb099caae36c) [@GBIFtax2022, via GBIF.org op `r Sys.Date()`].

```{r, cache=TRUE}
# Voeg wetenschappelijke namen toe
land_zoetwater_kust_selectie <- land_zoetwater_kust_selectie %>%
  st_drop_geometry() %>%
  rename(name = `scientific name`) %>%
  name_backbone_checklist() %>%
  select(verbatim_name, verbatim_family, scientificName, species, genus, family, 
         class, phylum, kingdom) %>%
  cbind(land_zoetwater_kust_selectie %>%
          select(-c(`scientific name`, family)))

# Krijg correcte namen met auteurs
auteurs <- land_zoetwater_kust_selectie %>%
  pull(species) %>%
  name_backbone_checklist() %>%
  select(scientificName) %>%
  pull()

# Maak aparte kolom voor auteursnamen
land_zoetwater_kust_selectie <- land_zoetwater_kust_selectie %>%
  mutate(scientificName = auteurs) %>%
  rowwise() %>%
  mutate(author = trimws(gsub(species, "", scientificName)))
```

Nu lossen we manueel nog de specifieke problemen van verzamelgroepen op.

```{r}
soortgroepen <- c("Arion rufus / ater", probleem_namen$scientificname)

land_zoetwater_kust_selectie <- land_zoetwater_kust_selectie %>%
  # Geen info over soortnaam of auteur als het een verzamelgroep is
  mutate(scientificName = 
           ifelse(verbatim_name %in% soortgroepen, NA, scientificName),
         species = 
           ifelse(verbatim_name %in% soortgroepen, NA, species),
         author = 
           ifelse(verbatim_name %in% soortgroepen, NA, author)) %>%
  # Pas soortnamen aan voor verzamelgroepen
  mutate(wet_soortnaam = case_when(
    verbatim_name == "Anisus leucostoma/spirorbis" ~ 
      "Anisus leucostoma/spirorbis",
    verbatim_name == "Arion (Carinarion) spec." ~ 
      "Arion sylvaticus/circumscriptus",
    verbatim_name == "Arion (Kobeltia) spec." ~ 
      "Arion hortensis/distinctus",
    verbatim_name == "Arion (Mesarion) spec." ~ 
      "Arion fuscus/subfuscus",
    verbatim_name == "Arion rufus / ater" ~ 
      "Arion rufus/ater",
    verbatim_name == "Arion rufus/vulgaris" ~ 
      "Arion rufus/vulgaris",
    verbatim_name == "Columella spec." ~ 
      "Columella edentula/aspera",
    verbatim_name == "Euconulus spec." ~ 
      "Euconulus spec.",
    verbatim_name == "Euglesa/Odhneripisidium/Pisidium spec." ~
      "Euglesa/Odhneripisidium/Pisidium spec.",
    verbatim_name == "Oxychilus spec." ~ 
      "Oxychilus spec.",
    verbatim_name == "Oxyloma spec." ~ 
      "Oxyloma elegans/sarsii",
    verbatim_name == "Stagnicola spec." ~ 
      "Stagnicola spec.",
    verbatim_name == "Succineidae indet." ~ 
      "Succineidae indet.",
    TRUE ~ scientificName
  )) %>%
  # Vul missende data aan op genus level
  mutate(genus = ifelse(verbatim_name == "Columella spec.", 
                        "Columella", genus))
```

Blijkbaar wordt het Meertandig muizenoortje *Myosotella denticulata* (Montagu, 1803) beschouwd als een synoniem van het Gewoon muizenoortje *Myosotella myosotis* (Draparnaud, 1801). Zie [GBIF](https://www.gbif.org/species/4359191) en [MolluscaBase](https://www.molluscabase.org/aphia.php?p=taxdetails&id=139672). Momenteel zal ik deze wel nog als aparte taxa beschouwen, dus dit moet manueel aangepast worden.

```{r}
land_zoetwater_kust_selectie <- land_zoetwater_kust_selectie %>%
  mutate(scientificName = ifelse(verbatim_name == "Myosotella denticulata",
                                 "Myosotella denticulata (Montagu, 1803)",
                                 scientificName),
         species = ifelse(verbatim_name == "Myosotella denticulata",
                                 "Myosotella denticulata",
                                 species),
         author = ifelse(verbatim_name == "Myosotella denticulata",
                                 "(Montagu, 1803)",
                                 author),
         wet_soortnaam = ifelse(verbatim_name == "Myosotella denticulata",
                                 "Myosotella denticulata (Montagu, 1803)",
                                 wet_soortnaam))
```

Hebben we nog missing data op genus level of hoger?

```{r}
land_zoetwater_kust_selectie %>% 
  filter_at(vars(genus, family, class, phylum, kingdom), 
            any_vars(is.na(.))) %>%
  select(wet_soortnaam, species, genus, family, class, phylum, kingdom) %>%
  kable()
```

Ok.


### Nederlandse soortnamen

We vergelijken de Nederlandse soortnamen met de @deBruyne2015. We passen de volgende namen aan (links: naam in dataset, rechts: naam in de @deBruyne2015):  
  
Boswegslak/Grauwe wegslak = Bos-wegslak / Grauwe wegslak  
Boswegslak = Bos-wegslak  
Egelwegslak = Egel-wegslak  
Arion rufus / ater = Rode wegslak / Duistere wegslak  
Rode wegslak/Spaanse wegslak = Rode wegslak / Spaanse wegslak  
Wormnaaktslak = Grijze wormnaaktslak  
Alinda biplicata biplicata = Grote clausilia  
Gewone driehoeksmossel = Driehoeksmossel  
Gewone wijngaardslak = Wijngaardslak  
Eénbandige grasslak = Eenbandige grasslak  
Grote karthuizerslak = Grote kartuizerslak  
Kleine karthuizerslak = Kleine kartuizerslak  
Gewone poelslak = Grote poelslak  
Glansslak-soort = Glansslak onbekend  
Posthoornslak = Posthorenslak  
Gewone kristalslak = Grote kristalslak  
Tandeloze korfslak/Ruwe korfslak = Tandloze korfslak / Ruwe korfslak  
Cylindrische korfslak = Cilindrische korfslak

```{r}
land_zoetwater_kust_selectie <- land_zoetwater_kust_selectie %>%
  mutate(`species name` = recode(`species name`, 
           "Boswegslak/Grauwe wegslak" = "Bos-wegslak / Grauwe wegslak",
           "Boswegslak" = "Bos-wegslak",
           "Egelwegslak" = "Egel-wegslak",
           "Arion rufus / ater" = "Rode wegslak / Duistere wegslak",
           "Rode wegslak/Spaanse wegslak" = "Rode wegslak / Spaanse wegslak",
           "Wormnaaktslak" = "Grijze wormnaaktslak",
           "Alinda biplicata biplicata" = "Grote clausilia",
           "Gewone driehoeksmossel" = "Driehoeksmossel",
           "Gewone wijngaardslak" = "Wijngaardslak",
           "Eénbandige grasslak" = "Eenbandige grasslak",
           "Grote karthuizerslak" = "Grote kartuizerslak",
           "Kleine karthuizerslak" = "Kleine kartuizerslak",
           "Gewone poelslak" = "Grote poelslak",
           "Glansslak-soort" = "Glansslak onbekend",
           "Posthoornslak" = "Posthorenslak",
           "Gewone kristalslak" = "Grote kristalslak",
           "Tandeloze korfslak/Ruwe korfslak" = 
             "Tandloze korfslak / Ruwe korfslak",
           "Cylindrische korfslak" = "Cilindrische korfslak"))
```


### Extra kolom toestand waarneming

In de kolom `life stage` vinden we de volgende informatie:

```{r}
land_zoetwater_kust_selectie %>%
  count(`life stage`) %>%
  arrange(`life stage`) %>%
  kable()
```

In de kolom `activity` vinden we de volgende informatie:

```{r} 
land_zoetwater_kust_selectie %>%
  count(activity) %>%
  arrange(activity) %>%
  kable()
```

Verder zit er ook informatie over elke waarneming in `notes`.

We willen een kolom `toestand` toevoegen met de 3 categoriën. Deze zijn te vinden in verschillende kolommen:

-   levend
    -   `life stage`: "levend dier" OF
    -   `activity`: "levend dier" OF
    -   `notes`: zoek voor woord "levend"
-   lege schelp
    -   `life stage`: ("doublet" OF "lege schelp of losse klep") OF
    -   `activity`: "dood" OF
    -   `notes`: zoek voor woord "vers" OF "oud" OF "dood" OF "doublet" OF "fragment" OF "leeg" OF "kokerjuffer" OF alleenstaande V (en verkeerde schrijfwijzes)
-   onbekend
    -   rest

```{r}
land_zoetwater_kust_selectie <- land_zoetwater_kust_selectie %>%
  mutate(toestand = case_when(
    `life stage` == "levend dier" | activity == "levend dier" | 
      grepl(pattern = "levend", tolower(notes)) 
         ~ "levend dier",
    `life stage` %in% c("doublet", "lege schelp of losse klep") | 
      activity == "dood" | 
      grepl(pattern = paste0("vers|o.?ud|dood|doublet|(frag|graf)ment|leeg|",
                             "kokerjuf|\\sv(\\s|\\/)"), tolower(notes)) 
         ~ "lege schelp",
    TRUE ~ "onbekend")
    )
```

```{r} 
land_zoetwater_kust_selectie %>%
  count(toestand) %>%
  arrange(toestand) %>%
  kable()
```


## Preparatie dataset

We selecteren de kolommen die voor ons van belang zijn en geven ze logische namen.

```{r}
final_df <- land_zoetwater_kust_selectie %>%
  select(id, datum = date, ned_soortnaam = `species name`, wet_soortnaam, 
         aantal = number, levensstadium = `life stage`, activiteit = activity, 
         toestand, methode = method, telmethode = `counting method`, 
         locatie = location, latitude = lat, longitude = lng, 
         lambert_x = `local x`, lambert_y = `local y`, precisie = accuracy, 
         notities = notes, is_zeker = `is certain`, link, verbatim_name, 
         species, author, genus, family, class, phylum, kingdom)
```


## Data exporteren

We slaan de finale dataset van waaremingen op als csv-bestand.

```{r}
write_csv(final_df, file = paste(out_path, "waarnemingen_kust.csv", sep = "/"))
```

We slaan ook een lijst op van alle gevonden soorten.

```{r}
soorten_lijst <- final_df %>%
  distinct(ned_soortnaam, wet_soortnaam, species, author, genus, 
           family, class, phylum, kingdom) %>% 
  arrange(kingdom, phylum, class, family, wet_soortnaam)

openxlsx::write.xlsx(soorten_lijst, 
  file = paste(out_path, "soortenlijst.xlsx", sep = "/"))
```

We slaan ten slotte een lijst op van de waarnemingen niet gedetermineerd tot op soortniveau en waarnemingen waarvan we de toestand niet weten (levend of lege schelp.)

```{r}
ongedetermineerd <- final_df %>%
  filter(is.na(species))

openxlsx::write.xlsx(ongedetermineerd, 
  file = paste(out_path, "ongedetermineerd.xlsx", sep = "/"))

onbekend <- final_df %>%
  filter(toestand == "onbekend")

openxlsx::write.xlsx(onbekend, 
  file = paste(out_path, "onbekende_toestand.xlsx", sep = "/"))
```

<!--chapter:end:03_dataselectie_kust.Rmd-->

# Verspreidingskaarten UTM-niveau{#verspreidingskaarten}
## Doel

Verspreidingskaarten maken voor alle soorten binnen het Slak-in-Dugebied aan de kust op verschillende schalen (1, 2, 5, 10 km).


## Data inlezen en voorbereiding

We lezen de volgende kaarten in: 

- UTM 1 km hokken in het Slak-in-Dugebied aan de kust
- UTM 2 km hokken in het Slak-in-Dugebied aan de kust
- UTM 5 km hokken in het Slak-in-Dugebied aan de kust
- UTM 10 km hokken in het Slak-in-Dugebied aan de kust
- Slak-in-Dugebied aan de kust

```{r, results="hide"}
# Locatie van data en output mappen
data_path <- file.path(slak_in_du_dir, "data", "raw")
out_path <- file.path(slak_in_du_dir, "data", "processed")

# Lees kaartlagen in
utm_1km_kust <- st_read(paste(out_path, "utm_1km_kust.shp", sep = "/"))
utm_2km_kust <- st_read(paste(out_path, "utm_2km_kust.shp", sep = "/"))
utm_5km_kust <- st_read(paste(out_path, "utm_5km_kust.shp", sep = "/"))
utm_10km_kust <- st_read(paste(out_path, "utm_10km_kust.shp", sep = "/"))

studiegebied_kust <- st_read(paste(out_path, "studiegebied_kust.shp", 
                                   sep = "/"))
studiegebied_kust_merged <- studiegebied_kust %>%
  st_buffer(0.5) %>%
  st_union()

# Referentie coordinatensysteem: UTM zone 31N
proj_crs <- 32631
```

Visualisatie van de kaartlagen:

```{r}
# Maak thema voor plotten van kaartjes
mytheme <- theme(panel.grid.major = element_line(color = "grey", 
                                                 linetype = "dashed", 
                                                 size = 0.3),
                 panel.background = element_rect(fill = "aliceblue"),
                 axis.title = element_blank(),
                 axis.ticks = element_blank(),
                 axis.text = element_blank())

# Plot kaarten
studiegebied_kust %>%
  ggplot() +
    geom_sf(aes(fill = ecoregio)) +
    mytheme

utm_1km_kust %>%
  ggplot() +
    geom_sf(data = studiegebied_kust_merged, fill = "white") +
    geom_sf(fill = alpha("white", 0)) +
    coord_sf(datum = proj_crs) +
    labs(title = "UTM 1 km - UTM zone 31N") +
    mytheme

utm_2km_kust %>%
  ggplot() +
    geom_sf(data = studiegebied_kust_merged, fill = "white") +
    geom_sf(fill = alpha("white", 0)) +
    coord_sf(datum = proj_crs) +
    labs(title = "UTM 2 km - UTM zone 31N") +
    mytheme

utm_5km_kust %>%
  ggplot() +
    geom_sf(data = studiegebied_kust_merged, fill = "white") +
    geom_sf(fill = alpha("white", 0)) +
    geom_sf_text(aes(label = TAG), size = 1.5) +
    coord_sf(datum = proj_crs) +
    labs(title = "UTM 5 km - UTM zone 31N") +
    mytheme

utm_10km_kust %>%
  ggplot() +
    geom_sf(data = studiegebied_kust_merged, fill = "white") +
    geom_sf(fill = alpha("white", 0)) +
    geom_sf_text(aes(label = TAG), size = 2.5) +
    coord_sf(datum = proj_crs) +
    labs(title = "UTM 10 km - UTM zone 31N") +
    mytheme
```

We lezen de waarnemingendata in van Slak-in-Du na data selectie en preparatie. We trekken een buffer rond elke waarneming die overeenkomt met hun nauwkeurigheid.

```{r}
# Laad data
slakken_data <- read_csv(paste(out_path, "waarnemingen_kust.csv", sep = "/"))

# Zet om naar sf object
slakken_data_sf <- slakken_data %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

# Zet crs om naar project crs
slakken_data_sf <- slakken_data_sf %>%
  st_transform(crs = proj_crs)

# Voeg buffer toe
slakken_data_sf_buffer <- slakken_data_sf %>%
  st_buffer(slakken_data_sf$precisie)
```


## Methodiek

Om de atlaskaarten te maken, kijken we naar de overlap van de UTM-hokken met de buffers. We willen echter dat buffers die meerdere hokken overlappen slechts het hok kleuren waar ze het grootste opppervlakte hebben. Beschouw bijvoorbeeld de volgende punten:

```{r}
punten <- data.frame(id = 1:2, 
                     x = c(492000,495500),
                     y = c(5678000, 5672000)) %>%
  st_as_sf(coords = c("x", "y"), crs = proj_crs) %>%
  st_buffer(1000)

utm_5km_kust %>%
  filter(startsWith(TAG, "DS97")) %>%
  ggplot() +
    geom_sf(fill = alpha("white", 0)) +
    geom_sf(data = punten) +
    coord_sf(datum = proj_crs) +
    mytheme
```

We willen niet dat alle hokken met overlap gekleurd worden zoals hier:

```{r}
# Neem intersectie punten met buffer en grid
intersection <- punten %>%
  st_intersection(utm_5km_kust %>%
    filter(startsWith(TAG, "DS97")))

# Lijst met UTM-hokken waar de soort voorkomt
utm_list <- unique(intersection$TAG)

# Add variable to resolution grid if species is present
utm_5km_kust %>%
  filter(startsWith(TAG, "DS97")) %>%
  mutate(occurrence = ifelse(TAG %in% utm_list, "present", "absent")) %>%
  ggplot() +
    geom_sf(data = punten) +
    geom_sf(aes(fill = occurrence), colour = alpha("white", 0)) +
    scale_fill_manual(values = c(alpha("white", 0), alpha("red", 0.4))) +
    geom_sf(data = utm_5km_kust %>% filter(startsWith(TAG, "DS97")),
            fill = alpha("white", 0)) +
    coord_sf(datum = proj_crs) +
    theme(legend.position = "") +
    mytheme
```

We willen wel de hokken met de grootste overlap kleuren, zoals hier:

```{r}
# Neem intersectie grid en punten met buffer
intersection <- utm_5km_kust %>%
  filter(startsWith(TAG, "DS97")) %>%
  st_intersection(punten) %>%

# Selecteer per plot het grootste deel
  mutate(oppervlakte = st_area(geometry)) %>%
  group_by(id) %>%
  filter(oppervlakte == max(oppervlakte))


# Lijst met UTM-hokken waar de soort voorkomt
utm_list <- unique(intersection$TAG)

# Add variable to resolution grid if species is present
utm_5km_kust %>%
  filter(startsWith(TAG, "DS97")) %>%
  mutate(occurrence = ifelse(TAG %in% utm_list, "present", "absent")) %>%
  ggplot() +
    geom_sf(data = punten) +
    geom_sf(aes(fill = occurrence), colour = alpha("white", 0)) +
    scale_fill_manual(values = c(alpha("white", 0), alpha("red", 0.4))) +
    geom_sf(data = utm_5km_kust %>% filter(startsWith(TAG, "DS97")),
            fill = alpha("white", 0)) +
    coord_sf(datum = proj_crs) +
    theme(legend.position = "") +
    mytheme
```


## Data exploratie
### Zoekinspanning

Voor we de verspreidingskaarten maken, is het belangrijk om een idee te hebben waar er precies is gezocht en met welke inspanning. Dit zal de interpretatie van de kaarten verbeteren. Zoekinspanning wordt hier gemeten als het aantal dagen per UTM-hok. Hokken waar we niet zijn geweest, zijn niet gekleurd (grijs).

```{r, cache=TRUE}
resoluties <- c(1, 2, 5, 10)

for (resolutie in resoluties) {
  p <- stats_utm_grid(data = slakken_data_sf_buffer, resolutie = resolutie, 
                      variabele = "datum") %>%
     ggplot() +
       geom_sf(data = studiegebied_kust_merged, fill = "white") +
       geom_sf(aes(fill =  n), alpha = 0.8, colour = alpha("white", 0)) +
       scale_fill_gradient(low = "red", high = "green") + 
       geom_sf(data = utm_10km_kust, fill =  alpha("white", 0), size = 0.7) +
       labs(title = "Aantal bezoeken per UTM hok", fill = "Aantal",
            subtitle = paste0("UTM ", resolutie, " km")) +
       coord_sf(datum = proj_crs) +
       mytheme
  
  if (resolutie %in% c(5, 10)) {
    p <- p + geom_sf_text(aes(label = n))
  }
  
  print(p)
}
```

### Soortenrijkdom

We tellen het aantal soorten per kilometerhok. We beschouwen enkel waarnemingen die tot op soort zijn gedetermineerd. Soortengroepen zijn dus ook niet meegerekend. Hokken waar we niet zijn geweest, zijn niet gekleurd (grijs).

```{r, cache=TRUE}
resoluties <- c(1, 2, 5, 10)

data <- slakken_data_sf_buffer %>%
  filter(!is.na(species))

for (resolutie in resoluties) {
  p <- stats_utm_grid(data = data, resolutie = resolutie, 
                      variabele = "species") %>%
     ggplot() +
       geom_sf(data = studiegebied_kust_merged, fill = "white") +
       geom_sf(aes(fill =  n), alpha = 0.8, colour = alpha("white", 0)) +
       scale_fill_gradient(low = "red", high = "green") + 
       geom_sf(data = utm_10km_kust, fill =  alpha("white", 0), size = 0.7) +
       labs(title = "Aantal soorten per UTM hok", fill = "Aantal",
            subtitle = paste0("UTM ", resolutie, " km")) +
       coord_sf(datum = proj_crs) +
       mytheme
  
  if (resolutie %in% c(5, 10)) {
    p <- p + geom_sf_text(aes(label = n))
  }
  
  print(p)
}
```

In hokken waar we minder zijn geweest zullen we uiteraard ook minder soorten zien. We zouden een relatieve maat moeten hebben om weer te geven welke hokken de grootste rijkdom hebben. Het aantal soorten per hok delen door het aantal bezoeken per hok is te extreem omdat er soms maar 1x een hok bezocht is en andere keren veel vaker. De controlerende factor zou allicht gevonden kunnen worden door het aantal soorten op de y-as uit te zetten tegenover het aantal bezoeken en te kijken vanaf hoeveel bezoeken de soortenrijkdom afzwakt. Als we die functie kunnen fitten zouden we een correctie kunnen uitvoeren, maar dit zou hier te ver leiden. Bovendien is ons design hier niet op voorbereid om dergelijke maten te berekenen wat zou kunnen leiden tot verkeerde conclusies.


## Verspreidingskaarten

```{r, cache=TRUE}
soorten <- slakken_data_sf_buffer %>% 
  st_drop_geometry() %>%
  arrange(class, family, wet_soortnaam) %>%
  distinct(ned_soortnaam, wet_soortnaam)
resoluties <- c(1, 2)

for (i in seq_len(nrow(soorten))) {
  soortnaam <- soorten$ned_soortnaam[i]
  wet_naam <- soorten$wet_soortnaam[i]
  for (resolutie in resoluties) {
    print(
    stats_utm_grid(data = slakken_data_sf_buffer, soortnaam = soortnaam, 
                   resolutie = resolutie) %>%
      ggplot() +
        geom_sf(data = studiegebied_kust_merged, fill = "white") +
        geom_sf(aes(fill = occurrence), colour = alpha("white", 0), 
                alpha = 0.8) +
        scale_fill_manual(values = c(alpha("green", 0.7), alpha("red", 0.7)),
                          labels = c("aangetroffen", "niet aangetroffen", 
                                     "niet bezocht")) +
        geom_sf(data = utm_10km_kust, fill =  alpha("white", 0), size = 0.7) +
        labs(title = paste0(soortnaam, " - ", wet_naam), fill = "Legende",
             subtitle = paste0("UTM ", resolutie, " km")) +
        coord_sf(datum = proj_crs) +
        theme(legend.justification = c(1, 0), legend.position = c(1, 0)) +
        mytheme
    )
  }
}
```

<!--chapter:end:04_atlas_kaarten_kust.Rmd-->

# Data exploratie{#exploratie}
## Doel

Exploratie van de waarnemingendata na selectie en preparatie.


## Data inlezen

We lezen de waarnemingendata in van Slak-in-Du na data selectie en preparatie.

```{r}
# Locatie van data en output mappen
data_path <- file.path(slak_in_du_dir, "data", "raw")
out_path <- file.path(slak_in_du_dir, "data", "processed")

# Referentie coordinatensysteem: UTM zone 31N
proj_crs <- 32631

# Laad data
slakken_data <- read_csv(paste(out_path, "waarnemingen_kust.csv", sep = "/"))

# Zet om naar sf object
slakken_data_sf <- slakken_data %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

# Zet crs om naar project crs
slakken_data_sf <- slakken_data_sf %>%
  st_transform(crs = proj_crs)

# Voeg buffer toe
slakken_data_sf_buffer <- slakken_data_sf %>%
  st_buffer(slakken_data_sf$precisie)
```


## Enkele cijfers

De eerste waarneming dateert van `r min(slakken_data$datum)` en de laatste van `r max(slakken_data$datum)` dit is een verschil van `r difftime(max(slakken_data$datum), min(slakken_data$datum))` dagen. In totaal hebben we `r nrow(slakken_data)` waarnemingen.

```{r}
slakken_data %>%
  mutate(jaar = lubridate::year(datum)) %>%
  group_by(jaar) %>%
  summarise("aantal waarnemingen" = n()) %>%
  kable("html") %>%
  kableExtra::kable_styling(full_width = FALSE)
```

```{r}
ggplot(slakken_data) +
  geom_bar(aes(x = lubridate::floor_date(datum, "month")), fill = "firebrick", 
           colour = "black") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  labs(x = "", y = "aantal waarnemingen per maand") +
  theme(panel.grid.minor.x = element_blank())
```

In totaal behoren de waarnemingen tot `r length(unique(slakken_data$wet_soortnaam))` taxa waarvan `r sum(complete.cases(unique(slakken_data$species)))` gedetermineert tot op soortniveau. Relatieve rang-abundatie curves kunnen een idee geven van soortenrijkdom en species evenness. Hoewel wij niet over abundanties beschikken, kunnen het relatief aantal waarnemingen wel een goed beeld geven. We beschouwen enkel de soorten gedetermineerd op soortniveau. Taxon rang: 1 = meest waargenomen soort, `r sum(complete.cases(unique(slakken_data$species)))` = minst waarngenomen soort.

```{r}
rel_obs <- slakken_data %>%
  filter(!is.na(species)) %>%
  group_by(ned_soortnaam, wet_soortnaam) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  arrange(desc(n)) %>%
  mutate(rel_n = n / nrow(slakken_data),
         rel_n_scaled = n / first(n),
         cum_n = cumsum(n), 
         cum_n_scaled = cum_n / (last(cum_n)/first(cum_n))) %>%
  rowid_to_column("rang")

rel_obs %>%
  ggplot() +
    geom_bar(aes(x = rang, y = n), stat = "identity", fill = "firebrick", 
           colour = "black") +
    geom_line(aes(x = rang, y = cum_n_scaled), size = 1, 
              colour = "cornflowerblue") +
    labs(x = "taxon rang", y = "aantal waarnemingen") +
    scale_x_continuous(breaks = c(min(rel_obs$rang), 25, 50, 
                         75, 100, 125, max(rel_obs$rang))) +
    scale_y_continuous(sec.axis = 
      sec_axis(~. / first(rel_obs$cum_n), name = "cumulatieve proportie"))

rel_obs %>%
  ggplot() +
    geom_line(aes(x = rang, y = rel_n_scaled), size = 1) +
    scale_x_continuous(breaks = c(min(rel_obs$rang), 25, 50, 
                         75, 100, 125, max(rel_obs$rang))) +
    labs(x = "taxon rang", y = "relatief aantal waarnemingen")
```

We zien een grote soortenrijkdom in de duinen. De curve is vrij stijl, wat wil zeggen dat de evenness is eerder laag is: hooggerangde soorten hebben een veel hoger aantal waarnemingen dan laaggerangde soorten.


## Samenvattende tabel

We maken een overzichtstabel waarbij we voor elke soort de prevalentie berekenen. De prevalentie $p$ is de proportie van UTM-hokken waar de soort is gevonden $n_{aanwezig}$ ten opzichte van het totaal aantal bezochte hokken $n_{bezocht}$.

$$
p = \frac{n_{aanwezig}}{n_{bezocht}}
$$

We geven ook aan om welke UTM-hokken het gaat. Daarnaast voegen we ook kolommen toe in welke toestand (levend, lege schelp of onbekend) de soort is aangetroffen in welke hokken.

```{r, cache=TRUE}
soortenlijst <- slakken_data %>%
  arrange(class, family, wet_soortnaam) %>%
  distinct(ned_soortnaam) %>%
  pull(ned_soortnaam)

# Prevalentie
prevalenties <- lapply(soortenlijst, get_prevalence, 
                       data = slakken_data_sf_buffer)

prev_df <- do.call(what = rbind.data.frame, args = prevalenties)
names(prev_df) <- c("ned_soortnaam", "prevalentie", "utm_hokken")

# UTM-hokken toestand
toestanden <- lapply(soortenlijst, get_life_stats, 
                     data = slakken_data_sf_buffer)

toest_df <- do.call(what = rbind.data.frame, args = toestanden)
names(toest_df) <- c("ned_soortnaam", "levend_dier", "lege_schelp", "onbekend")

# Voeg samen en voeg wetenschappelijke soortnaam toe
df_tot <- full_join(prev_df, toest_df, by = "ned_soortnaam") %>%
  left_join(slakken_data_sf_buffer, by = "ned_soortnaam") %>%
  select("ned_soortnaam", "wet_soortnaam", "prevalentie", "utm_hokken", 
         "levend_dier", "lege_schelp", "onbekend") %>%
  distinct() %>%
  as.data.frame()

df_tot %>%
  kable()

# Exporteer als .xlsx
openxlsx::write.xlsx(df_tot, 
  file = paste(out_path, "samenvattende_tabel.xlsx", sep = "/"))
```

De verdeling van de prevalenties op UTM 10 km niveau ziet er als volgt uit.

```{r}
ggplot(df_tot) +
  geom_bar(aes(x = prevalentie), fill = "firebrick", colour = "black") +
  scale_x_continuous(limits = c(0, 1)) +
  labs(y = "aantal soorten")
```

<!--chapter:end:05_data_exploratie.Rmd-->

# Referenties

<!--chapter:end:06_Referenties.Rmd-->

