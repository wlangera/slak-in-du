---
title: "Data exploratie"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output: 
  html_document:
      code_folding: hide
      toc: true
      toc_float: true
      toc_collapsed: true
      df_print: paged
  editor_options:
      chunk_output_type: console
---

```{r setup, include=FALSE}
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
opts_knit$set(root.dir = here::here())

library(tidyverse)
library(sf)
library(lubridate)

source(here("src", "R", "functions.R"))
```


# Doel

Exploratie van de waarnemingendata na selectie en preparatie.


# Data inlezen

We lezen de waarnemingendata in van Slak-in-Du na data selectie en preparatie.

```{r}
# Locatie van data en output mappen
data_path <- here("data", "raw")
out_path <- here("data", "processed")

# Referentie coordinatensysteem: UTM zone 31N
proj_crs <- 32631

# Laad data
slakken_data <- read_csv(paste(out_path, "waarnemingen_kust.csv", sep = "/"))

# Zet om naar sf object
slakken_data_sf <- slakken_data %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

# Zet crs om naar project crs
slakken_data_sf <- slakken_data_sf %>%
  st_transform(crs = proj_crs)

# Voeg buffer toe
slakken_data_sf_buffer <- slakken_data_sf %>%
  st_buffer(slakken_data_sf$precisie)
```


# Enkele cijfers

De eerste waarneming dateert van `r min(slakken_data$datum)` en de laatste van `r max(slakken_data$datum)` dit is een verschil van `r difftime(max(slakken_data$datum), min(slakken_data$datum))` dagen. In totaal hebben we `r nrow(slakken_data)` waarnemingen.

```{r}
slakken_data %>%
  mutate(jaar = year(datum)) %>%
  group_by(jaar) %>%
  summarise("aantal waarnemingen" = n()) %>%
  kable()
```

```{r}
ggplot(slakken_data) +
  geom_bar(aes(x = floor_date(datum, "month")), fill = "firebrick", 
           colour = "black") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  labs(x = "", y = "aantal waarnemingen per maand") +
  theme(panel.grid.minor.x = element_blank())
```


# Samenvattende tabel

We maken een overzichtstabel waarbij we voor elke soort de prevalentie berekenen. De prevalentie $p$ is de proportie van UTM-hokken waar de soort is gevonden $n_{aanwezig}$ ten opzichte van het totaal aantal bezochte hokken $n_{bezocht}$.

$$
p = \frac{n_{aanwezig}}{n_{bezocht}}
$$

We geven ook aan om welke UTM-hokken het gaat. Daarnaast voegen we ook kolommen toe in welke toestand (levend, lege schelp of onbekend) de soort is aangetroffen in welke hokken.

```{r}
soortenlijst <- slakken_data %>%
  arrange(class, family, wet_soortnaam) %>%
  distinct(ned_soortnaam) %>%
  pull(ned_soortnaam)

# Prevalentie
prevalenties <- lapply(soortenlijst, get_prevalence, 
                       data = slakken_data_sf_buffer)

prev_df <- do.call(what = rbind.data.frame, args = prevalenties)
names(prev_df) <- c("ned_soortnaam", "prevalentie", "utm_hokken")

# UTM-hokken toestand
toestanden <- lapply(soortenlijst, get_life_stats, 
                     data = slakken_data_sf_buffer)

toest_df <- do.call(what = rbind.data.frame, args = toestanden)
names(toest_df) <- c("ned_soortnaam", "levend_dier", "lege_schelp", "onbekend")

# Voeg samen en voeg wetenschappelijke soortnaam toe
df_tot <- full_join(prev_df, toest_df, by = "ned_soortnaam") %>%
  left_join(slakken_data_sf_buffer, by = "ned_soortnaam") %>%
  select("ned_soortnaam", "wet_soortnaam", "prevalentie", "utm_hokken", 
         "levend_dier", "lege_schelp", "onbekend") %>%
  distinct()

df_tot %>%
  kable()

# Exporteer als .xlsx
```

De verdeling van de prevalenties ziet er als volgt uit.

```{r}
ggplot(df_tot) +
  geom_bar(aes(x = prevalentie), fill = "firebrick", colour = "black") +
  scale_x_continuous(limits = c(0, 1)) +
  labs(y = "aantal soorten")
```
